<!doctype html>
<head>
    <meta charset="utf-8">

    <title>{{ title }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.0rc2/jquery.mobile-1.0rc2.min.css" />
    <script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.0rc2/jquery.mobile-1.0rc2.min.js"></script>

    <script src="/socket.io/socket.io.js"></script>

    <style>
        #message {
            height:200px;
            width:200px;
            background-color:#000;
        }
    </style>

    <script>
        $(document).ready(function() {
            var clientId = parseInt(Math.random()*1000);
            var isConnected = false;
            var timeOffset = 0;
            var hasLocalStorage = ('localStorage' in window && window['localStorage'] !== null) ? true : false;
            var testAudio = "/audio/nu_click.mp3";
            
			var start = new Date().getTime(),
    			time = 0,
    			elapsed = '0.0',
    			globalDiff = 0;
            
            
            // Create player
            var player = $('<audio>', {
                id          : 'player',
                autobuffer  : 'autobuffer',  
                preload     : 'auto',
                controls    : false,
                src         : testAudio
            }).appendTo('#message')[0]; 
            
            // Create button
            $('#message').bind("click", function(e) {
                player.play();
            });
            
            // Create socket
            var socket = io.connect(document.domain, {
                'reconnect': true,
                'reconnection delay': 500,
                'max reconnection attempts': 5
            });
            
            // Connect client
            socket.on('connect', function () {
                console.log('connected');
                isConnected = true;
                
                //$('#connected').text('Connected');
                
                // Emit clientId
                socket.emit('setClientId', clientId);
                
                $(player).attr('data-isloaded', false);
                $(player).bind('canplaythrough', function(){
                    $("#log").html("loaded");
                    $("#src").html("src " + $(player).attr("src"));
                    $(this).attr('data-isloaded', true);
                    socket.emit('messageLoaded', clientId);
                });
                
                socket.on("networkTime", function(time) {
                    timeOffset = getClientTime(time);
                    //console.log("ti", timeOffset, time);
                });
                
                // Message change event handler.
                socket.on("messageChange", function onMessageChange(json) {
                    console.log('message changed');
                    $("#log").html("changed message start");
                    var params = $.parseJSON(json);
                    var id = params.id,
                        timestamp = params.ts,
                        src = '/protests/' + id,
                        cache;

                    timeOffset = getClientTime(timestamp); 
                    
                    // Reset isLoaded
                    $(player).attr("data-isloaded", false);
                    
                    // TODO: Check if message is in localStorage
                    /*if (hasLocalStorage){
                        cache = localStorage.getItem(id);
                    }
                    if (cache) src = cache;*/
                    
                    // Load new audio file
                    $(player).attr("src", src);
                    //$(player).children("source").attr("src", src);
                    $(player).load();
                    
                    $("#log").html("changed message finished");
                });
                
                // Message play handler
                socket.on("messagePlay", function onMessagePlay(json) {
                    $("#log").html("play message");
                    var params = $.parseJSON(json);
                    var id = params.id,
                        timestamp = params.ts;
                    
                    timeOffset = getClientTime(timestamp);
                    
                    var playAt = (params.tsAt - timeOffset);
                    var timeOut = playAt - new Date().getTime();

                    if (timeOut < 0) {
                       //dont play, too far behind.
                    } else {
                       window.setTimeout(function() {
                           $("#log").html("play message timeout");
                           if (player && $(player).attr('data-isloaded')) {
                               $("#log").html("play message complete");
                               console.log("player", player);
                               player.play();
                           }
                       }, timeOut);
                    }                    
                });                
            });
        });
        
        function getClientTime(time) {
            return time - new Date().getTime() + globalDiff;
        }
        
        
		function systemClockDiff() {
			time += 100;
			elapsed = Math.floor(time / 100) / 10;
			if(Math.round(elapsed) == elapsed) { elapsed += '.0'; }
			globalDiff = (new Date().getTime() - start) - time;
			setTimeout(instance, (100 - globalDiff));
		}

        setTimeout(systemClockDiff, 100);
    </script>
</head>

<body>
    <div data-role="page" class="type-index">
        <div data-role="content">
            <div id="message"></div>
            <div id="log"></div>
            <div id="src"></div>
        </div>
    </div>
</body>
</html>

